name: newsbot-seo-hatena

on:
  schedule:
    # Run daily at 10:00 JST (01:00 UTC)
    - cron: '0 1 * * *'
  workflow_dispatch:
    # Allow manual trigger

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: main
        persist-credentials: true

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create .env file
      run: |
        cat << EOF > .env
        LLM_PROVIDER=${{ secrets.LLM_PROVIDER }}
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        OPENAI_MODEL=${{ secrets.OPENAI_MODEL }}
        ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
        ANTHROPIC_MODEL=${{ secrets.ANTHROPIC_MODEL }}
        PUBLISH_PLATFORM=hatena
        NEWSBOT_PROFILE=seo
        PROMPT_VARIANT=seo
        HATENA_DRAFT=false
        AUTO_REPUBLISH=false
        NEWSBOT_DOTENV_OVERRIDE=false
        HATENA_ID=${{ secrets.HATENA_ID }}
        HATENA_BLOG_ID=${{ secrets.HATENA_BLOG_ID }}
        HATENA_API_KEY=${{ secrets.HATENA_API_KEY }}
        HATENA_OAUTH_CONSUMER_KEY=${{ secrets.HATENA_OAUTH_CONSUMER_KEY }}
        HATENA_OAUTH_CONSUMER_SECRET=${{ secrets.HATENA_OAUTH_CONSUMER_SECRET }}
        HATENA_OAUTH_ACCESS_TOKEN=${{ secrets.HATENA_OAUTH_ACCESS_TOKEN }}
        HATENA_OAUTH_ACCESS_TOKEN_SECRET=${{ secrets.HATENA_OAUTH_ACCESS_TOKEN_SECRET }}
        HATENA_FOTOLIFE_POST_URI=${{ secrets.HATENA_FOTOLIFE_POST_URI }}
        HATENA_FOTOLIFE_FOLDER=${{ secrets.HATENA_FOTOLIFE_FOLDER }}
        HATENA_IMAGE_MAX_WIDTH=${{ secrets.HATENA_IMAGE_MAX_WIDTH }}
        HATENA_IMAGE_QUALITY=${{ secrets.HATENA_IMAGE_QUALITY }}
        HATENA_IMAGE_STRICT=${{ secrets.HATENA_IMAGE_STRICT }}
        HATENA_ATOM_ENDPOINT=${{ secrets.HATENA_ATOM_ENDPOINT }}
        HATENA_CONTENT_TYPE=${{ secrets.HATENA_CONTENT_TYPE || 'text/html' }}
        HATENA_FORCE_HTML=${{ secrets.HATENA_FORCE_HTML || 'true' }}
        HATENA_STRIP_H1=${{ secrets.HATENA_STRIP_H1 || 'true' }}
        HATENA_FORMAT_PARAGRAPHS=${{ secrets.HATENA_FORMAT_PARAGRAPHS || 'true' }}
        HATENA_PARAGRAPH_SENTENCES=${{ secrets.HATENA_PARAGRAPH_SENTENCES || '2' }}
        HATENA_CATEGORIES=${{ secrets.HATENA_CATEGORIES }}
        UNSPLASH_ACCESS_KEY=${{ secrets.UNSPLASH_ACCESS_KEY }}
        RSS_FEEDS=${{ secrets.RSS_FEEDS }}
        CACHE_DURATION_HOURS=${{ secrets.CACHE_DURATION_HOURS }}
        MAX_ARTICLES_PER_RUN=${{ secrets.MAX_ARTICLES_PER_RUN }}
        MAX_TOKENS_PER_RUN=${{ secrets.MAX_TOKENS_PER_RUN }}
        ALLOWLIST_PATH=${{ secrets.ALLOWLIST_PATH || 'config/allowlist.txt' }}
        KEYWORD_CONFIG_PATH=${{ secrets.KEYWORD_CONFIG_PATH || 'config/category_keywords.json' }}
        JSON_LOGS=${{ secrets.JSON_LOGS }}
        DRAFT_PATH=out/draft.md
        REVENUE_MODEL=${{ secrets.REVENUE_MODEL }}
        FUNNEL_STAGE=${{ secrets.FUNNEL_STAGE }}
        PRIMARY_QUERY=${{ secrets.PRIMARY_QUERY }}
        RELATED_QUERIES=${{ secrets.RELATED_QUERIES }}
        TARGET_READER=${{ secrets.TARGET_READER }}
        GOAL_ACTION=${{ secrets.GOAL_ACTION }}
        PR_DISCLOSURE=${{ secrets.PR_DISCLOSURE }}
        FIRST_PARTY_INFO=${{ secrets.FIRST_PARTY_INFO }}
        EXISTING_URLS=${{ secrets.EXISTING_URLS }}
        AFFILIATE_CATEGORIES=${{ secrets.AFFILIATE_CATEGORIES }}
        TITLE_HINT=${{ secrets.TITLE_HINT }}
        CTA_WEAK_TEXT=${{ secrets.CTA_WEAK_TEXT }}
        CTA_WEAK_URL=${{ secrets.CTA_WEAK_URL }}
        CTA_STRONG_TEXT=${{ secrets.CTA_STRONG_TEXT }}
        CTA_STRONG_URL=${{ secrets.CTA_STRONG_URL }}
        INTERNAL_LINKS=${{ secrets.INTERNAL_LINKS }}
        PLAN_ENABLED=${{ secrets.PLAN_ENABLED }}
        FINAL_CHECK_ENABLED=${{ secrets.FINAL_CHECK_ENABLED }}
        FINAL_CHECK_PATH=${{ secrets.FINAL_CHECK_PATH || 'out/final_check.md' }}
        EOF

    - name: Run newsbot (seo profile)
      run: |
        python main.py --profile seo

    - name: Upload draft artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: seo-hatena-draft-${{ github.run_number }}
        path: |
          out/draft.md
          newsbot.log
        retention-days: 30

    - name: Commit cache
      if: success()
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add cache.json || true
        git diff --staged --quiet || git commit -m "chore: update article cache [skip ci]"
        git push origin HEAD:main || true
